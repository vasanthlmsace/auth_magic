{"version":3,"file":"authmagic.min.js","sources":["../src/authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Magic authentication define js.\r\n * @module   auth_magic\r\n * @copyright  2022 bdecent gmbh <https://bdecent.de>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n define(['jquery', 'core/fragment', 'core/modal_factory', 'core/modal_events', 'core/notification', 'core/str'],\r\n function($, Fragment, ModalFactory, ModalEvents, notification, String) {\r\n\r\n    /**\r\n     * Controls Custom styles tool action.\r\n     * @param {object} params\r\n     */\r\n    var AuthMagic = function(params) {\r\n        var self = this;\r\n        if (params.enrolstatus !== undefined) {\r\n            self.displayAuthInfoBox(params);\r\n        }\r\n        if (params.cancopylink !== undefined) {\r\n            self.copyuserLoginlink(params.cancopylink);\r\n        }\r\n        if (params.loginhook) {\r\n            self.magicLoginHook(params);\r\n        }\r\n        if (params.hascourseregister) {\r\n            self.courseQuickRegistration(params);\r\n        }\r\n        return true;\r\n    };\r\n\r\n    AuthMagic.prototype.courseQuickRegistration = function(params) {\r\n        var uniqueid = \"user-index-participants-\" + params.courseid;\r\n        var handleSelector = \".pagelayout-incourse [data-table-uniqueid=\" + uniqueid + \"]\";\r\n        var addHandler = document.querySelectorAll(handleSelector);\r\n        if (addHandler) {\r\n            var singleButton = document.createElement(\"div\");\r\n            singleButton.setAttribute(\"class\", \"singlebutton quickregister-button\");\r\n\r\n            // Create a form.\r\n            var form = document.createElement(\"form\");\r\n            form.setAttribute(\"method\", \"get\");\r\n            form.setAttribute(\"action\", params.url);\r\n            form.setAttribute(\"id\", \"quickregister-button\");\r\n\r\n            // Create an input element for Full Name\r\n            var courseblock = document.createElement(\"input\");\r\n            courseblock.setAttribute(\"type\", \"hidden\");\r\n            courseblock.setAttribute(\"name\", \"courseid\");\r\n            courseblock.setAttribute(\"value\", params.courseid);\r\n\r\n            var submit = document.createElement(\"input\");\r\n            submit.setAttribute(\"type\", \"submit\");\r\n            submit.setAttribute(\"value\", params.strquickregister);\r\n            submit.setAttribute(\"class\", \"btn btn-secondary my-1\");\r\n\r\n            form.appendChild(courseblock);\r\n            form.appendChild(submit);\r\n            singleButton.appendChild(form);\r\n            addHandler[0].appendChild(singleButton);\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.magicLoginHook = function(params) {\r\n        var authSelector = \"#page-login-index .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\r\n        if (authSelector) {\r\n            var getMagicLink = document.querySelectorAll(authSelector)[0];\r\n            var potentialiDp = $(\"#page-login-index .potentialidplist\").prev();\r\n            var potentialiDpList = document.querySelectorAll(\"#page-login-index .potentialidplist .potentialidp\");\r\n            if (getMagicLink === undefined) {\r\n                authSelector = \"#page-login-index .login-identityproviders a\";\r\n                var getMagicLinks = document.querySelectorAll(authSelector);\r\n                if (getMagicLinks.length) {\r\n                    getMagicLinks.forEach(function(item) {\r\n                        var inner = item.innerHTML.trim();\r\n                        if (inner == params.strbutton) {\r\n                            getMagicLink = item;\r\n                            potentialiDpList = document.querySelectorAll(\"#page-login-index .login-identityproviders a\");\r\n                            potentialiDp = document.querySelectorAll(\"#page-login-index .login-identityproviders h2\")[0];\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n            if (getMagicLink) {\r\n                getMagicLink.classList.remove(\"btn-secondary\");\r\n                getMagicLink.classList.add(\"btn-primary\");\r\n                var userNameBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[0];\r\n                if (userNameBlock) {\r\n                    userNameBlock.appendChild(getMagicLink);\r\n                    // Create a span.\r\n                    var span = document.createElement(\"span\");\r\n                    span.setAttribute(\"class\", \"magic-password-instruction\");\r\n                    var passInfo = String.get_string('passinfo', 'auth_magic');\r\n                    $.when(passInfo).done(function(localizedEditString) {\r\n                        span.innerHTML = localizedEditString;\r\n                    });\r\n                    userNameBlock.appendChild(span);\r\n                }\r\n                if (potentialiDpList.length <= 1) {\r\n                    $(potentialiDp).hide();\r\n                        var identityProvider = document.querySelectorAll(\"#page-login-index .login-identityproviders\")[0];\r\n                        if (identityProvider) {\r\n                            $(identityProvider).prev().hide();\r\n                            $(identityProvider).next().hide();\r\n                        }\r\n                }\r\n                getMagicLink.addEventListener(\"click\", function(e) {\r\n                    e.preventDefault();\r\n                    var returnurl = e.currentTarget.getAttribute(\"href\");\r\n                    var userEmail = \"\";\r\n                    var mailSelector = document.querySelectorAll(\"form#login #username\")[0];\r\n                    if (mailSelector) {\r\n                        userEmail = mailSelector.value;\r\n                    }\r\n                    // Create a form.\r\n                    var form = document.createElement(\"form\");\r\n                    form.setAttribute(\"method\", \"post\");\r\n                    form.setAttribute(\"action\", returnurl);\r\n                    form.setAttribute(\"id\", \"magic-login-form\");\r\n\r\n                        // Create an input element for Full Name\r\n                    var magicLogin = document.createElement(\"input\");\r\n                    magicLogin.setAttribute(\"type\", \"hidden\");\r\n                    magicLogin.setAttribute(\"name\", \"magiclogin\");\r\n                    magicLogin.setAttribute(\"value\", 1);\r\n\r\n                    var email = document.createElement(\"input\");\r\n                    email.setAttribute(\"type\", \"hidden\");\r\n                    email.setAttribute(\"name\", \"usermail\");\r\n                    email.setAttribute(\"value\", userEmail);\r\n\r\n                    form.appendChild(magicLogin);\r\n                    form.appendChild(email);\r\n\r\n                    getMagicLink.parentNode.appendChild(form);\r\n\r\n                    var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\r\n                    magicForm.submit();\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.copyuserLoginlink = function(cancopylink) {\r\n        var self = this;\r\n        if (cancopylink) {\r\n            var invitationlink = document.querySelectorAll(\"table.magicinvitationlink .magic-invitationlink\");\r\n            if (invitationlink) {\r\n                invitationlink.forEach(function(items) {\r\n                    items.addEventListener('click', function(e) {\r\n                        e.preventDefault();\r\n                        var userlogin = e.currentTarget.getAttribute(\"data-invitationlink\");\r\n                        self.copyText(userlogin);\r\n                    });\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.copyTextCliboard = function() {\r\n        var self = this;\r\n        var copyTextBlock = document.querySelectorAll(\".auth-magic-block #copy-text\")[0];\r\n        if (copyTextBlock) {\r\n            self.copyText(copyTextBlock.value, true);\r\n            copyTextBlock.select();\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.copyText = function(copytext, modal = false) {\r\n        if (typeof (navigator.clipboard) == 'undefined') {\r\n            var textArea = document.createElement(\"textarea\");\r\n            textArea.value = copytext;\r\n            // Avoid scrolling to bottom\r\n            textArea.style.top = \"0\";\r\n            textArea.style.left = \"0\";\r\n            textArea.style.position = \"fixed\";\r\n            if (!modal) {\r\n                document.body.appendChild(textArea);\r\n            } else {\r\n                document.querySelectorAll(\".modal .modal-content\")[0].appendChild(textArea);\r\n            }\r\n            textArea.focus();\r\n            textArea.select();\r\n            try {\r\n                document.execCommand('copy');\r\n            } catch (err) {\r\n                return false;\r\n            }\r\n            if (!modal) {\r\n                document.body.removeChild(textArea);\r\n            } else {\r\n                document.querySelectorAll(\".modal .modal-content\")[0].removeChild(textArea);\r\n            }\r\n        } else {\r\n            navigator.clipboard.writeText(copytext);\r\n        }\r\n        return true;\r\n    };\r\n\r\n    AuthMagic.prototype.displayAuthInfoBox = function(params) {\r\n        var self = this;\r\n        ModalFactory.create({\r\n            title: params.strconfirm,\r\n            type: ModalFactory.types.CANCEL,\r\n            body: self.getAuthMagicBody(params),\r\n            large: true\r\n        }).then(function(modal) {\r\n            modal.show();\r\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\r\n                var copyBoardButton = document.querySelectorAll(\".auth-magic-block .copy-link-block #copy-cliboard\")[0];\r\n                if (copyBoardButton) {\r\n                    copyBoardButton.addEventListener(\"click\", self.copyTextCliboard.bind(self));\r\n                }\r\n            });\r\n            modal.getRoot().on(ModalEvents.hidden, function() {\r\n                modal.destroy();\r\n                window.open(params.returnurl, '_self');\r\n            });\r\n            return modal;\r\n        }).catch(notification.exception);\r\n    };\r\n\r\n    AuthMagic.prototype.getAuthMagicBody = function(params) {\r\n        return Fragment.loadFragment('auth_magic', 'display_box_content', params.contextid, params);\r\n    };\r\n\r\n    return {\r\n        init: function(params) {\r\n            return new AuthMagic(params);\r\n        }\r\n    };\r\n\r\n });"],"names":["define","$","Fragment","ModalFactory","ModalEvents","notification","String","AuthMagic","params","undefined","enrolstatus","this","displayAuthInfoBox","cancopylink","copyuserLoginlink","loginhook","magicLoginHook","hascourseregister","courseQuickRegistration","prototype","handleSelector","courseid","addHandler","document","querySelectorAll","singleButton","createElement","setAttribute","form","url","courseblock","submit","strquickregister","appendChild","authSelector","strbutton","getMagicLink","potentialiDp","prev","potentialiDpList","getMagicLinks","length","forEach","item","innerHTML","trim","classList","remove","add","userNameBlock","span","passInfo","get_string","when","done","localizedEditString","hide","identityProvider","next","addEventListener","e","preventDefault","returnurl","currentTarget","getAttribute","userEmail","mailSelector","value","magicLogin","email","parentNode","self","invitationlink","items","userlogin","copyText","copyTextCliboard","copyTextBlock","select","copytext","modal","navigator","clipboard","textArea","style","top","left","position","body","focus","execCommand","err","removeChild","writeText","create","title","strconfirm","type","types","CANCEL","getAuthMagicBody","large","then","show","getRoot","on","bodyRendered","copyBoardButton","bind","hidden","destroy","window","open","catch","exception","loadFragment","contextid","init"],"mappings":"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"}