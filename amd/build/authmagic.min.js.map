{"version":3,"file":"authmagic.min.js","sources":["../src/authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Magic authentication define js.\n * @module   auth_magic\n * @copyright  2022 bdecent gmbh <https://bdecent.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n define(['jquery', 'core/fragment', 'core/modal_factory', 'core/modal_events', 'core/notification', 'core/str'],\n function($, Fragment, ModalFactory, ModalEvents, notification, String) {\n\n    /**\n     * Controls Custom styles tool action.\n     * @param {object} params\n     */\n    var AuthMagic = function(params) {\n        var self = this;\n        if (params.enrolstatus !== undefined) {\n            self.displayAuthInfoBox(params);\n            setTimeout(function() {\n                var copyBoardButton = document.querySelectorAll(\".auth-magic-block .copy-link-block #copy-cliboard\")[0];\n                if (copyBoardButton) {\n                    copyBoardButton.addEventListener(\"click\", self.copyTextCliboard.bind(self));\n                }\n            }, 2000);\n        }\n        if (params.cancopylink !== undefined) {\n            self.copyuserLoginlink(params.cancopylink);\n        }\n        if (params.loginhook) {\n            self.magicLoginHook(params);\n        }\n        if (params.hascourseregister) {\n            self.courseQuickRegistration(params);\n        }\n    };\n\n    AuthMagic.prototype.courseQuickRegistration = function(params) {\n        var uniqueid = \"user-index-participants-\" + params.courseid;\n        var handleSelector = \".pagelayout-incourse [data-table-uniqueid=\" + uniqueid + \"]\";\n        var addHandler = document.querySelectorAll(handleSelector);\n        if (addHandler) {\n            var singleButton = document.createElement(\"div\");\n            singleButton.setAttribute(\"class\", \"singlebutton quickregister-button\");\n\n            // Create a form.\n            var form = document.createElement(\"form\");\n            form.setAttribute(\"method\", \"get\");\n            form.setAttribute(\"action\", params.url);\n            form.setAttribute(\"id\", \"quickregister-button\");\n\n            // Create an input element for Full Name\n            var courseblock = document.createElement(\"input\");\n            courseblock.setAttribute(\"type\", \"hidden\");\n            courseblock.setAttribute(\"name\", \"courseid\");\n            courseblock.setAttribute(\"value\", params.courseid);\n\n            var submit = document.createElement(\"input\");\n            submit.setAttribute(\"type\", \"submit\");\n            submit.setAttribute(\"value\", params.strquickregister);\n            submit.setAttribute(\"class\", \"btn btn-secondary my-1\");\n\n            form.appendChild(courseblock);\n            form.appendChild(submit);\n            singleButton.appendChild(form);\n            addHandler[0].appendChild(singleButton);\n        }\n    };\n\n    AuthMagic.prototype.magicLoginHook = function(params) {\n        var authSelector = \"#page-login-index .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\n        var getMagicLink = document.querySelectorAll(authSelector)[0];\n            if (getMagicLink) {\n                getMagicLink.classList.remove(\"btn-secondary\");\n                getMagicLink.classList.add(\"btn-primary\");\n                var userNameBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[0];\n                if (userNameBlock) {\n                    userNameBlock.appendChild(getMagicLink);\n                    // Create a span.\n                    var span = document.createElement(\"span\");\n                    span.setAttribute(\"class\", \"magic-password-instruction\");\n                    var passInfo = String.get_string('passinfo', 'auth_magic');\n                    $.when(passInfo).done(function(localizedEditString) {\n                        span.innerHTML = localizedEditString;\n                   });\n                    userNameBlock.appendChild(span);\n                }\n                var potentialiDp = $(\"#page-login-index .potentialidplist\").prev();\n                var potentialiDpList = document.querySelectorAll(\"#page-login-index .potentialidplist .potentialidp\");\n                if (potentialiDpList.length <= 1) {\n                    $(potentialiDp).hide();\n                }\n                getMagicLink.addEventListener(\"click\", function(e) {\n                    e.preventDefault();\n                    var returnurl = e.currentTarget.getAttribute(\"href\");\n                    var userEmail = \"\";\n                    var mailSelector = document.querySelectorAll(\"form#login #username\")[0];\n                    if (mailSelector) {\n                        userEmail = mailSelector.value;\n                    }\n                    // Create a form.\n                    var form = document.createElement(\"form\");\n                    form.setAttribute(\"method\", \"post\");\n                    form.setAttribute(\"action\", returnurl);\n                    form.setAttribute(\"id\", \"magic-login-form\");\n\n                     // Create an input element for Full Name\n                    var magicLogin = document.createElement(\"input\");\n                    magicLogin.setAttribute(\"type\", \"hidden\");\n                    magicLogin.setAttribute(\"name\", \"magiclogin\");\n                    magicLogin.setAttribute(\"value\", 1);\n\n                    var email = document.createElement(\"input\");\n                    email.setAttribute(\"type\", \"hidden\");\n                    email.setAttribute(\"name\", \"usermail\");\n                    email.setAttribute(\"value\", userEmail);\n\n                    form.appendChild(magicLogin);\n                    form.appendChild(email);\n\n                    getMagicLink.parentNode.appendChild(form);\n\n                    var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\n                    magicForm.submit();\n                });\n            }\n    };\n\n    AuthMagic.prototype.copyuserLoginlink = function(cancopylink) {\n        var self = this;\n        if (cancopylink) {\n            var invitationlink = document.querySelectorAll(\"table.magicinvitationlink .magic-invitationlink\");\n            if (invitationlink) {\n                invitationlink.forEach(function(items) {\n                    items.addEventListener('click', function(e) {\n                        e.preventDefault();\n                        var userlogin = e.currentTarget.getAttribute(\"data-invitationlink\");\n                        self.copyText(userlogin);\n                    });\n                });\n            }\n        }\n    };\n\n    AuthMagic.prototype.copyTextCliboard = function() {\n        var self = this;\n        var copyTextBlock = document.querySelectorAll(\".auth-magic-block #copy-text\")[0];\n        if (copyTextBlock) {\n            self.copyText(copyTextBlock.value, true);\n            copyTextBlock.select();\n        }\n    };\n\n    AuthMagic.prototype.copyText = function(copytext, modal = false) {\n        if (typeof (navigator.clipboard) == 'undefined') {\n            var textArea = document.createElement(\"textarea\");\n            textArea.value = copytext;\n            // Avoid scrolling to bottom\n            textArea.style.top = \"0\";\n            textArea.style.left = \"0\";\n            textArea.style.position = \"fixed\";\n            if (!modal) {\n                document.body.appendChild(textArea);\n            } else {\n                document.querySelectorAll(\".modal .modal-content\")[0].appendChild(textArea);\n            }\n            textArea.focus();\n            textArea.select();\n            try {\n                document.execCommand('copy');\n            } catch (err) {\n                return false;\n            }\n            if (!modal) {\n                document.body.removeChild(textArea);\n            } else {\n                document.querySelectorAll(\".modal .modal-content\")[0].removeChild(textArea);\n            }\n        } else {\n            navigator.clipboard.writeText(copytext);\n        }\n        return true;\n    };\n\n    AuthMagic.prototype.displayAuthInfoBox = function(params) {\n        var self = this;\n        ModalFactory.create({\n            title: params.strconfirm,\n            type: ModalFactory.types.CANCEL,\n            body: self.getAuthMagicBody(params),\n            large: true\n        }).then(function(modal) {\n\n            modal.show();\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n                window.open(params.returnurl, '_self');\n            });\n            return modal;\n        }).catch(notification.exception);\n    };\n\n    AuthMagic.prototype.getAuthMagicBody = function(params) {\n        return Fragment.loadFragment('auth_magic', 'display_box_content', params.contextid, params);\n    };\n\n    return {\n        init: function(params) {\n            return new AuthMagic(params);\n        }\n    };\n\n });"],"names":["define","$","Fragment","ModalFactory","ModalEvents","notification","String","AuthMagic","params","self","this","undefined","enrolstatus","displayAuthInfoBox","setTimeout","copyBoardButton","document","querySelectorAll","addEventListener","copyTextCliboard","bind","cancopylink","copyuserLoginlink","loginhook","magicLoginHook","hascourseregister","courseQuickRegistration","prototype","handleSelector","courseid","addHandler","singleButton","createElement","setAttribute","form","url","courseblock","submit","strquickregister","appendChild","authSelector","strbutton","getMagicLink","classList","remove","add","userNameBlock","span","passInfo","get_string","when","done","localizedEditString","innerHTML","potentialiDp","prev","length","hide","e","preventDefault","returnurl","currentTarget","getAttribute","userEmail","mailSelector","value","magicLogin","email","parentNode","invitationlink","forEach","items","userlogin","copyText","copyTextBlock","select","copytext","modal","navigator","clipboard","textArea","style","top","left","position","body","focus","execCommand","err","removeChild","writeText","create","title","strconfirm","type","types","CANCEL","getAuthMagicBody","large","then","show","getRoot","on","hidden","destroy","window","open","catch","exception","loadFragment","contextid","init"],"mappings":"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"}