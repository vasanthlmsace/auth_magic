{"version":3,"file":"authmagic.min.js","sources":["authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Magic authentication define js.\r\n * @module   auth_magic\r\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['core/str'],\r\nfunction(String) {\r\n\r\n    /**\r\n    * Controls Custom styles tool action.\r\n    * @param {object} params\r\n    */\r\n    var AuthMagic = function(params) {\r\n        var self = this;\r\n        if (params.loginhook) {\r\n            self.magicLoginHook(params);\r\n        }\r\n        if (params.customloginhook) {\r\n            self.magicCustomLoginHook(params);\r\n        }\r\n        return true;\r\n    };\r\n\r\n    AuthMagic.prototype.magicCustomLoginHook = function(params) {\r\n        var self = this;\r\n        var MagicLink = self.getMagicLink(params, \"#page-local-magic-login\");\r\n        if (MagicLink) {\r\n            self.magicLoginHandler(MagicLink, \"form#login #id_email\");\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.getMagicLink = function(params, linkId) {\r\n        var authSelector = linkId + \" .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\r\n        var MagicLink = \"\";\r\n        if (authSelector) {\r\n            MagicLink = document.querySelectorAll(authSelector)[0];\r\n            var potentialiDp = document.querySelector(linkId + \" .potentialidplist\");\r\n            if (potentialiDp) {\r\n                potentialiDp = potentialiDp.previousElementSibling;\r\n            }\r\n            var potentialiDpList = document.querySelectorAll(linkId + \" .potentialidplist .potentialidp\");\r\n            if (MagicLink === undefined) {\r\n                authSelector = linkId + \" .login-identityproviders a\";\r\n                var MagicLinks = document.querySelectorAll(authSelector);\r\n                if (MagicLinks.length) {\r\n                    MagicLinks.forEach(function(item) {\r\n                        var inner = item.innerHTML.trim();\r\n                        if (inner == params.strbutton) {\r\n                            MagicLink = item;\r\n                            potentialiDpList = document.querySelectorAll(linkId + \" .login-identityproviders a\");\r\n                            potentialiDp = document.querySelectorAll(linkId + \" .login-identityproviders h2\")[0];\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n        return MagicLink;\r\n    };\r\n\r\n    AuthMagic.prototype.magicLoginHook = function(params) {\r\n        var self = this;\r\n        var MagicLink = self.getMagicLink(params, \"#page-login-index\");\r\n        if (MagicLink) {\r\n            if (!document.querySelector(\"#page-login-index .potentialidplist\")) {\r\n                MagicLink.classList.remove(\"btn-secondary\");\r\n                MagicLink.classList.add(\"btn-primary\");\r\n            }\r\n            if (!params.linkbtnpos) {\r\n                params.linkbtnpos = 0;\r\n            }\r\n            if (params.linkbtnpos == 0) {\r\n                var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\r\n                if (MagicLinkBlock) {\r\n                    MagicLinkBlock.appendChild(MagicLink);\r\n                    // Create a span.\r\n                    var span = document.createElement(\"span\");\r\n                    span.setAttribute(\"class\", \"magic-password-instruction\");\r\n                    var passInfo = String.get_string('passinfo', 'auth_magic');\r\n                    passInfo.done(function(localizedEditString) {\r\n                        span.innerHTML = localizedEditString;\r\n                    });\r\n                    MagicLinkBlock.appendChild(span);\r\n                }\r\n            }\r\n            if (params.linkbtnpos == 1) {\r\n                var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\r\n                if (MagicLinkBlock) {\r\n                    MagicLinkBlock.appendChild(MagicLink);\r\n                }\r\n            }\r\n\r\n            if (params.linkbtnpos <= 1 ) {\r\n                if (potentialiDpList.length <= 1) {\r\n                    potentialiDp.style.display = 'none';\r\n                    var identityProvider = document.querySelectorAll(\"#page-login-index .login-identityproviders\")[0];\r\n                    if (identityProvider) {\r\n                        identityProvider.previousElementSibling.style.display = 'none';\r\n                        identityProvider.nextElementSibling.style.display = 'none';\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (params.linkbtnpos == 2) {\r\n                MagicLink.classList.remove(\"btn-primary\");\r\n            }\r\n            self.magicLoginHandler(MagicLink, \"form#login #username\");\r\n        }\r\n    };\r\n\r\n    AuthMagic.prototype.magicLoginHandler = function(MagicLink, mailHandler) {\r\n        MagicLink.addEventListener(\"click\", function(e) {\r\n            e.preventDefault();\r\n            var returnurl = e.currentTarget.getAttribute(\"href\");\r\n            var userValue = \"\";\r\n            //form#login #username\r\n            var mailSelector = document.querySelectorAll(mailHandler)[0];\r\n            if (mailSelector) {\r\n                userValue = mailSelector.value;\r\n            }\r\n            // Create a form.\r\n            var form = document.createElement(\"form\");\r\n            form.setAttribute(\"method\", \"post\");\r\n            form.setAttribute(\"action\", returnurl);\r\n            form.setAttribute(\"id\", \"magic-login-form\");\r\n\r\n                // Create an input element for Full Name\r\n            var magicLogin = document.createElement(\"input\");\r\n            magicLogin.setAttribute(\"type\", \"hidden\");\r\n            magicLogin.setAttribute(\"name\", \"magiclogin\");\r\n            magicLogin.setAttribute(\"value\", 1);\r\n\r\n            var uservalue = document.createElement(\"input\");\r\n            uservalue.setAttribute(\"type\", \"hidden\");\r\n            uservalue.setAttribute(\"name\", \"uservalue\");\r\n            uservalue.setAttribute(\"value\", userValue);\r\n\r\n            form.appendChild(magicLogin);\r\n            form.appendChild(uservalue);\r\n\r\n            MagicLink.parentNode.appendChild(form);\r\n\r\n            var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\r\n            magicForm.submit();\r\n        });\r\n    }\r\n\r\n    return {\r\n        init: function(params) {\r\n            return new AuthMagic(params);\r\n        }\r\n    };\r\n\r\n});"],"names":["define","String","AuthMagic","params","loginhook","this","magicLoginHook","customloginhook","magicCustomLoginHook","prototype","MagicLink","getMagicLink","magicLoginHandler","linkId","authSelector","strbutton","document","querySelectorAll","potentialiDp","querySelector","previousElementSibling","undefined","MagicLinks","length","forEach","item","innerHTML","trim","MagicLinkBlock","classList","remove","add","linkbtnpos","appendChild","span","createElement","setAttribute","get_string","done","localizedEditString","potentialiDpList","style","display","identityProvider","nextElementSibling","mailHandler","addEventListener","e","preventDefault","returnurl","currentTarget","getAttribute","userValue","mailSelector","value","form","magicLogin","uservalue","parentNode","submit","init"],"mappings":"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"}