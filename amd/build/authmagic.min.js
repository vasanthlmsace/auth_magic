/**
 * Magic authentication define js.
 * @module   auth_magic
 * @copyright  2022 bdecent gmbh <https://bdecent.de>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("auth_magic/authmagic",["jquery","core/fragment","core/modal_factory","core/modal_events","core/notification","core/str"],(function($,Fragment,ModalFactory,ModalEvents,notification,String){var AuthMagic=function(params){return void 0!==params.enrolstatus&&this.displayAuthInfoBox(params),void 0!==params.cancopylink&&this.copyuserLoginlink(params.cancopylink),params.loginhook&&this.magicLoginHook(params),params.hascourseregister&&this.courseQuickRegistration(params),!0};return AuthMagic.prototype.courseQuickRegistration=function(params){var handleSelector=".pagelayout-incourse [data-table-uniqueid="+("user-index-participants-"+params.courseid)+"]",addHandler=document.querySelectorAll(handleSelector);if(addHandler){var singleButton=document.createElement("div");singleButton.setAttribute("class","singlebutton quickregister-button");var form=document.createElement("form");form.setAttribute("method","get"),form.setAttribute("action",params.url),form.setAttribute("id","quickregister-button");var courseblock=document.createElement("input");courseblock.setAttribute("type","hidden"),courseblock.setAttribute("name","courseid"),courseblock.setAttribute("value",params.courseid);var submit=document.createElement("input");submit.setAttribute("type","submit"),submit.setAttribute("value",params.strquickregister),submit.setAttribute("class","btn btn-secondary my-1"),form.appendChild(courseblock),form.appendChild(submit),singleButton.appendChild(form),addHandler[0].appendChild(singleButton)}},AuthMagic.prototype.magicLoginHook=function(params){var authSelector='#page-login-index .potentialidplist a[title="'+params.strbutton+'"]';if(authSelector){var getMagicLink=document.querySelectorAll(authSelector)[0],potentialiDp=$("#page-login-index .potentialidplist").prev(),potentialiDpList=document.querySelectorAll("#page-login-index .potentialidplist .potentialidp");if(void 0===getMagicLink){authSelector="#page-login-index .login-identityproviders a";var getMagicLinks=document.querySelectorAll(authSelector);getMagicLinks.length&&getMagicLinks.forEach((function(item){item.innerHTML.trim()==params.strbutton&&(getMagicLink=item,potentialiDpList=document.querySelectorAll("#page-login-index .login-identityproviders a"),potentialiDp=document.querySelectorAll("#page-login-index .login-identityproviders h2")[0])}))}if(getMagicLink){getMagicLink.classList.remove("btn-secondary"),getMagicLink.classList.add("btn-primary");var userNameBlock=document.querySelectorAll("#page-login-index form#login .form-group")[0];if(userNameBlock){userNameBlock.appendChild(getMagicLink);var span=document.createElement("span");span.setAttribute("class","magic-password-instruction");var passInfo=String.get_string("passinfo","auth_magic");$.when(passInfo).done((function(localizedEditString){span.innerHTML=localizedEditString})),userNameBlock.appendChild(span)}if(potentialiDpList.length<=1){$(potentialiDp).hide();var identityProvider=document.querySelectorAll("#page-login-index .login-identityproviders")[0];identityProvider&&($(identityProvider).prev().hide(),$(identityProvider).next().hide())}getMagicLink.addEventListener("click",(function(e){e.preventDefault();var returnurl=e.currentTarget.getAttribute("href"),userEmail="",mailSelector=document.querySelectorAll("form#login #username")[0];mailSelector&&(userEmail=mailSelector.value);var form=document.createElement("form");form.setAttribute("method","post"),form.setAttribute("action",returnurl),form.setAttribute("id","magic-login-form");var magicLogin=document.createElement("input");magicLogin.setAttribute("type","hidden"),magicLogin.setAttribute("name","magiclogin"),magicLogin.setAttribute("value",1);var email=document.createElement("input");email.setAttribute("type","hidden"),email.setAttribute("name","usermail"),email.setAttribute("value",userEmail),form.appendChild(magicLogin),form.appendChild(email),getMagicLink.parentNode.appendChild(form),document.querySelectorAll("form#magic-login-form")[0].submit()}))}}},AuthMagic.prototype.copyuserLoginlink=function(cancopylink){var self=this;if(cancopylink){var invitationlink=document.querySelectorAll("table.magicinvitationlink .magic-invitationlink");invitationlink&&invitationlink.forEach((function(items){items.addEventListener("click",(function(e){e.preventDefault();var userlogin=e.currentTarget.getAttribute("data-invitationlink");self.copyText(userlogin)}))}))}},AuthMagic.prototype.copyTextCliboard=function(){var copyTextBlock=document.querySelectorAll(".auth-magic-block #copy-text")[0];copyTextBlock&&(this.copyText(copyTextBlock.value,!0),copyTextBlock.select())},AuthMagic.prototype.copyText=function(copytext){let modal=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(void 0===navigator.clipboard){var textArea=document.createElement("textarea");textArea.value=copytext,textArea.style.top="0",textArea.style.left="0",textArea.style.position="fixed",modal?document.querySelectorAll(".modal .modal-content")[0].appendChild(textArea):document.body.appendChild(textArea),textArea.focus(),textArea.select();try{document.execCommand("copy")}catch(err){return!1}modal?document.querySelectorAll(".modal .modal-content")[0].removeChild(textArea):document.body.removeChild(textArea)}else navigator.clipboard.writeText(copytext);return!0},AuthMagic.prototype.displayAuthInfoBox=function(params){var self=this;ModalFactory.create({title:params.strconfirm,type:ModalFactory.types.CANCEL,body:self.getAuthMagicBody(params),large:!0}).then((function(modal){return modal.show(),modal.getRoot().on(ModalEvents.bodyRendered,(function(){var copyBoardButton=document.querySelectorAll(".auth-magic-block .copy-link-block #copy-cliboard")[0];copyBoardButton&&copyBoardButton.addEventListener("click",self.copyTextCliboard.bind(self))})),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy(),window.open(params.returnurl,"_self")})),modal})).catch(notification.exception)},AuthMagic.prototype.getAuthMagicBody=function(params){return Fragment.loadFragment("auth_magic","display_box_content",params.contextid,params)},{init:function(params){return new AuthMagic(params)}}}));

//# sourceMappingURL=authmagic.min.js.map